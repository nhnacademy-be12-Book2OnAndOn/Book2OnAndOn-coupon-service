#name: CI/CD for Coupon Service
#
#on:
#  push:
#    branches: [ "main", "master" ]
#  workflow_dispatch:
#
#permissions:
#  contents: read
#  packages: write
#
#jobs:
#  deploy:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v3
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#          cache: 'maven'
#
#      - name: Build with Maven
#        run: |
#          chmod +x mvnw
#          ./mvnw clean package -DskipTests
#
#      - name: Login to GitHub Container Registry
#        uses: docker/login-action@v2
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Build and Push Docker Image
#        uses: docker/build-push-action@v4
#        with:
#          context: .
#          file: ./Dockerfile
#          platforms: linux/amd64
#          push: true
#          tags: ghcr.io/nhnacademy-be12-book2onandon/coupon-service:v1
#
#      - name: Deploy via SSH
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ secrets.SERVER_HOST }}
#          username: ${{ secrets.SERVER_USERNAME }}
#          password: ${{ secrets.SERVER_PASSWORD }}
#          port: ${{ secrets.SERVER_PORT }}
#          script: |
#            cd /home/backend/be12-team2
#
#            SERVICE_NAME="COUPON-SERVICE"
#            EUREKA_URL="http://admin:admin1234@localhost:10437/eureka"
#
#            docker compose pull coupon-1 coupon-2
#
#            # [1] coupon-1 배포
#            INSTANCE_ID_1="$SERVICE_NAME:coupon-1"
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=OUT_OF_SERVICE" || true
#            sleep 30
#            docker compose up -d coupon-1
#            sleep 40
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=UP" || true
#
#            # [2] coupon-2 배포
#            INSTANCE_ID_2="$SERVICE_NAME:coupon-2"
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=OUT_OF_SERVICE" || true
#            sleep 30
#            docker compose up -d coupon-2
#            sleep 40
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=UP" || true
#
#            docker image prune -f

name: CI/CD for Coupon Service

on:
  push:
    branches: [ "dev" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarQube packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and Analyze with SonarQube
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONARQUBE_HOST_URL }}
        run: |
          chmod +x mvnw
          ./mvnw clean verify sonar:sonar \
            -Dsonar.projectKey=Book2onandon-coupon-service \
            -Dsonar.projectName="Book2onandon-coupon-service" \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN \
            -Dspring.cloud.config.enabled=false \
            -Dspring.config.import="optional:file:./"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ghcr.io/nhnacademy-be12-book2onandon/coupon-service:v1

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /home/backend/be12-team2
            
            SERVICE_NAME="COUPON-SERVICE"
            EUREKA_URL="http://admin:admin1234@localhost:10437/eureka"
            
            docker compose pull coupon-1 coupon-2

            # [1] coupon-1 배포 (Rolling Update)
            INSTANCE_ID_1="$SERVICE_NAME:coupon-1"
            # 유레카에서 제외 (OUT_OF_SERVICE)
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=OUT_OF_SERVICE" || true
            
            sleep 30
            
            # 컨테이너 재시작
            docker compose up -d coupon-1
            
            sleep 40
            
            # 유레카 복귀 (UP)
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=UP" || true

            # [2] coupon-2 배포 (Rolling Update)
            INSTANCE_ID_2="$SERVICE_NAME:coupon-2"
            # 유레카에서 제외
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=OUT_OF_SERVICE" || true
            
            sleep 30
            
            # 컨테이너 재시작
            docker compose up -d coupon-2
            
            sleep 40
            
            # 유레카 복귀
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=UP" || true

            # 미사용 이미지 정리
            docker image prune -f